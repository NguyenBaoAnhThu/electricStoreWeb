<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thêm Đơn Hàng</title>
    <link rel="stylesheet" th:href="@{/css/admin/fragments/sidebar.css}">
    <link rel="stylesheet" th:href="@{/css/admin/fragments/header.css}">
    <link rel="stylesheet" th:href="@{/css/admin/fragments/footer.css}">
    <link rel="stylesheet" th:href="@{/css/admin/layout/layout.css}">
    <link rel="stylesheet" th:href="@{/css/admin/layout/tablelayout.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body>
<div th:replace="~{admin/fragments/header :: header}"></div>
<div th:replace="~{admin/fragments/sidebar :: sidebar}"></div>
<main class="main-content">
    <div class="wrapper">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="tittle">Tạo Đơn Hàng</h1>
        </div>

        <form id="orderForm" th:action="@{/Admin/order/create}" method="POST" th:object="${orderDTO}" class="needs-validation" novalidate>
            <div class="form-container position-relative mb-3">
                <div class="red-bar"></div>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="orderCode" class="form-label">Mã Đơn Hàng</label>
                        <input type="text" class="form-control bg-light" id="orderCode" name="orderCode" th:field="*{invoiceNumber}" readonly>
                    </div>
                </div>
            </div>

            <div class="form-container position-relative mb-3">
                <div class="red-bar"></div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">Thông Tin Khách Hàng</h5>
                    <button type="button" class="btn btn-primary" id="selectCustomerBtn">
                        <i class="fas fa-users me-1"></i> Chọn khách hàng
                    </button>
                </div>

                <input type="hidden" th:field="*{customerDTO.customerId}" id="customerId">

                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="customerCode" class="form-label">Mã Khách Hàng</label>
                        <input type="text" class="form-control bg-light" id="customerCode" name="customerCode" value="Tự sinh khi lưu" readonly>
                        <input type="hidden" th:field="*{customerDTO.customerCode}" id="customerCodeHidden">
                    </div>
                    <div class="col-md-4">
                        <label for="customerName" class="form-label">Tên Khách Hàng <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="customerName" name="customerName" th:field="*{customerDTO.customerName}" required>
                        <p class="error text-danger" id="customerNameError" th:if="${#fields.hasErrors('customerDTO.customerName')}" th:errors="*{customerDTO.customerName}"></p>
                    </div>
                    <div class="col-md-4">
                        <label for="customerPhoneNumber" class="form-label">Số Điện Thoại <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="customerPhoneNumber" name="customerPhoneNumber" th:field="*{customerDTO.phoneNumber}" required>
                        <p class="error text-danger" id="phoneNumberError" th:if="${#fields.hasErrors('customerDTO.phoneNumber')}" th:errors="*{customerDTO.phoneNumber}"></p>
                    </div>
                    <div class="col-md-4">
                        <label for="customerEmail" class="form-label">Email <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" id="customerEmail" name="customerEmail" th:field="*{customerDTO.email}" required>
                        <p class="error text-danger" id="emailError" th:if="${#fields.hasErrors('customerDTO.email')}" th:errors="*{customerDTO.email}"></p>
                    </div>
                    <div class="col-md-4">
                        <label for="customerAddress" class="form-label">Địa chỉ <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="customerAddress" name="customerAddress" th:field="*{customerDTO.address}" required>
                        <p class="error text-danger" id="addressError" th:if="${#fields.hasErrors('customerDTO.address')}" th:errors="*{customerDTO.address}"></p>
                    </div>
                    <div class="col-md-4">
                        <label for="customerBirthdate" class="form-label">Ngày Sinh <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="customerBirthdate" name="customerBirthdate"
                               th:field="*{customerDTO.birthDate}"
                               placeholder="dd/MM/yyyy"
                               pattern="(0[1-9]|[12][0-9]|3[01])/(0[1-9]|1[012])/(19|20)\d\d"
                               required>
                        <p class="error text-danger" id="birthDateError" th:if="${#fields.hasErrors('customerDTO.birthDate')}" th:errors="*{customerDTO.birthDate}"></p>
                    </div>
                </div>
            </div>

            <div class="form-container position-relative mb-3">
                <div class="red-bar"></div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">Sản Phẩm</h5>
                    <button type="button" class="btn btn-primary" id="addProductButton">
                        <i class="fas fa-plus me-1"></i> Thêm sản phẩm
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered product-table">
                        <thead>
                        <tr>
                            <th width="50">STT</th>
                            <th>Tên Sản Phẩm</th>
                            <th width="110">Số Lượng</th>
                            <th width="150">Đơn Giá (VNĐ)</th>
                            <th width="160">Thành Tiền (VNĐ)</th>
                            <th width="50">Xóa</th>
                        </tr>
                        </thead>
                        <tbody id="productList">
                        </tbody>
                    </table>
                    <div id="noProductsMessage" class="text-center text-muted mt-3">
                        Chưa có sản phẩm nào được thêm.
                    </div>
                </div>
            </div>

            <div class="totals-container position-relative mb-3">
                <div class="red-bar"></div>
                <h5 class="fw-bold mb-3">Thanh Toán</h5>
                <div class="row mb-2">
                    <div class="col-md-6">
                        <label class="form-label">Tổng số lượng sản phẩm:</label>
                        <strong id="totalQuantity" class="ms-2">0</strong>
                    </div>
                    <div class="col-md-6 text-end">
                        <label class="form-label">Tổng tiền hàng:</label>
                        <strong id="totalAmount" class="ms-2">0</strong>
                    </div>
                </div>
                <hr class="my-2">
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label for="discountAmount" class="form-label">Giảm giá (VNĐ):</label>
                        <input type="text" class="form-control text-end" id="discountAmount" name="discountAmount" value="0"
                               oninput="formatInputCurrency(this)" onblur="formatInputCurrency(this); calculateTotal();">
                        <span class="text-danger validation-message d-none">Giá trị không hợp lệ</span>
                    </div>
                    <div class="col-md-4">
                        <label for="discountPercent" class="form-label">Giảm giá (%):</label>
                        <input type="text" class="form-control text-end" id="discountPercent" name="discountPercent" min="0" max="100" value="0" step="0.1"
                               onchange="calculateTotal();">
                        <span class="text-danger validation-message d-none">Giá trị không hợp lệ</span>
                    </div>
                    <div class="col-md-4">
                        <label for="paymentMethod" class="form-label">Hình thức thanh toán <span class="text-danger">*</span></label>
                        <select class="form-select" id="paymentMethod" th:field="*{paymentMethod}" required>
                            <option value="0">-- Chọn phương thức --</option>
                            <option value="1">Chuyển khoản</option>
                            <option value="2">Tiền mặt</option>
                        </select>
                        <p class="error text-danger" id="paymentMethodError" th:if="${#fields.hasErrors('paymentMethod')}" th:errors="*{paymentMethod}"></p>
                    </div>
                </div>
                <hr class="my-2">
                <div class="row mb-2">
                    <div class="col-md-12 text-end">
                        <label class="form-label fw-bold fs-5">TỔNG GIÁ TRỊ ĐƠN HÀNG (VNĐ):</label>
                        <span id="grandTotal" class="ms-2 fw-bold fs-5 text-danger">0</span>
                        <input type="hidden" id="total" name="total" th:field="*{totalPrice}">
                    </div>
                </div>
                <div class="form-check mb-3" style="display:none;">
                    <input class="form-check-input" type="checkbox" id="defaultCheck1" th:field="*{isPrintInvoice}" checked>
                    <label class="form-check-label" for="defaultCheck1">
                        In hóa đơn
                    </label>
                </div>
                <input type="hidden" name="isPrintInvoice" value="true" />
            </div>

            <div class="d-flex justify-content-end gap-2">
                <button type="submit" class="btn btn-success btn-action">
                    Thanh toán
                </button>
                <button type="button" class="btn btn-danger btn-action" id="cancelBtn">
                    Hủy
                </button>
            </div>
        </form>
    </div>
</main>

<!-- Modal xác nhận huỷ đơn hàng -->
<div class="modal fade" id="cancelConfirmModal" tabindex="-1" aria-labelledby="cancelConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="cancelConfirmModalLabel">Xác Nhận Hủy Đơn Hàng</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-flex align-items-center">
                <div class="me-3 text-dark">
                    <i class="material-icons" style="font-size:48px; color:black;">error_outline</i>
                </div>
                <div>
                    <p class="mb-0">Mọi thay đổi trong đơn hàng này sẽ bị mất và không thể khôi phục. Bạn có chắc chắn muốn hủy?</p>
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-primary" id="confirmCancelBtn">Xác nhận</button>
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Hủy</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal thanh toán QR code -->
<div class="modal fade" id="qrPaymentModal" tabindex="-1" aria-labelledby="qrPaymentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width: 900px;">
            <div class="modal-content">
            <div class="modal-header bg-dark text-white py-2">
                <h5 class="modal-title" id="qrPaymentModalLabel">Thanh Toán Chuyển Khoản</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3">
                <div class="d-flex flex-wrap flex-md-nowrap gap-3 align-items-start">
                    <div class="flex-shrink-0 text-center" style="min-width:220px;">
                        <div class="qr-title mb-2"><i class="fas fa-qrcode me-2"></i>Quét mã QR</div>
                        <div class="qr-container p-2 mb-2" style="background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.06);">
                            <div class="qr-code" style="width:180px;height:180px;display:flex;align-items:center;justify-content:center;">
                                <img th:src="@{/images/qrcode.jpg}" alt="QR Code thanh toán" width="160" height="160" style="max-width:100%;height:auto;border-radius:4px;" />
                            </div>
                        </div>
                        <div class="qr-info small text-muted">Dùng app ngân hàng/ví điện tử để quét mã</div>
                    </div>
                    <div class="flex-grow-1">
                        <div class="row g-2">
                            <div class="col-12 col-md-6">
                                <div class="bank-details p-2 mb-2" style="background:#f8f9fa;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.03);">
                                    <div class="fw-bold mb-2" style="font-size:1rem;">Chuyển khoản</div>
                                    <div class="detail-row d-flex justify-content-between small mb-1">
                                        <span class="detail-label">Ngân hàng:</span>
                                        <span class="detail-value">Vietcombank</span>
                                    </div>
                                    <div class="detail-row d-flex justify-content-between small mb-1">
                                        <span class="detail-label">Số tài khoản:</span>
                                        <span class="detail-value">1234567890123</span>
                                    </div>
                                    <div class="detail-row d-flex justify-content-between small mb-1">
                                        <span class="detail-label">Chủ tài khoản:</span>
                                        <span class="detail-value">ELECTRIC STORE</span>
                                    </div>
                                    <div class="detail-row d-flex justify-content-between small mb-1">
                                        <span class="detail-label">Số tiền:</span>
                                        <span class="detail-value"><span id="paymentAmount">0</span></span>
                                    </div>
                                    <div class="detail-row d-flex justify-content-between small mb-1">
                                        <span class="detail-label">Nội dung:</span>
                                        <span class="detail-value"><span id="paymentContent">THANH TOAN DH </span></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="order-summary p-2 mb-2" style="background:#f8f9fa;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.03);">
                                    <div class="fw-bold mb-2" style="font-size:1rem;">Đơn hàng</div>
                                    <div class="detail-row d-flex justify-content-between small mb-1">
                                        <span class="detail-label">Mã đơn:</span>
                                        <span class="detail-value" id="orderCodeDisplay"></span>
                                    </div>
                                    <div class="detail-row d-flex justify-content-between small mb-1">
                                        <span class="detail-label">Khách:</span>
                                        <span class="detail-value" id="customerNameDisplay"></span>
                                    </div>
                                    <div class="detail-row d-flex justify-content-between small mb-1">
                                        <span class="detail-label">Số điện thoại :</span>
                                        <span class="detail-value" id="customerPhoneDisplay"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="note-section mt-2 small text-muted" style="background:transparent;box-shadow:none;">
                            <ul class="mb-1 ps-3">
                                <li>Nhập đúng nội dung chuyển khoản</li>
                                <li>Đơn hàng sẽ xác nhận sau khi nhận được tiền</li>
                                <li>Hỗ trợ: support@example.com / 1900 1234</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer py-2 d-flex justify-content-between">
                <button type="button" class="btn btn-secondary btn-sm px-3" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary btn-sm px-3" id="confirmPaymentBtn">Xác Nhận Thanh Toán</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal thông báo cần chọn khách hàng -->
<div class="modal fade" id="customerRequiredModal" tabindex="-1" aria-labelledby="customerRequiredModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="customerRequiredModalLabel">Thông Báo</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-flex align-items-center">
                <div class="me-3 text-dark">
                    <i class="material-icons" style="font-size:48px; color:black;">error_outline</i>
                </div>
                <div>
                    <p class="mb-0">Vui lòng chọn khách hàng trước khi thêm sản phẩm.</p>
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>
<!-- Modal thông báo lỗi tồn kho -->
<div class="modal fade" id="stockErrorModal" tabindex="-1" aria-labelledby="stockErrorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h6 class="modal-title mb-0" id="stockErrorModalLabel">
                    Lỗi Tồn Kho
                </h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-3">
                <div id="stockErrorModalBody" class="text-start small">
                    <!-- Nội dung lỗi sẽ được chèn ở đây -->
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center pb-3">
                <button type="button" class="btn btn-primary btn-sm" data-bs-dismiss="modal">
                    Đóng
                </button>
            </div>
        </div>
    </div>
</div>
<div th:replace="~{admin/fragments/footer :: footer}"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/admin/layout.js}"></script>
<script th:src="@{/js/admin/sidebarActiveMenu.js}" defer></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        if (window.history && window.history.pushState) {
            window.history.pushState({form: true}, '');
            window.history.pushState({form: true}, '');
        }

        // Xử lý nút back của trình duyệt
        window.addEventListener('popstate', function(e) {
            // Kiểm tra nếu có dữ liệu trong form
            const hasCustomerData = sessionStorage.getItem("selectedCustomer") || sessionStorage.getItem("selectedNewCustomer");
            const hasProductData = sessionStorage.getItem("selectedProduct");
            if (hasCustomerData || hasProductData) {
                // Hiện modal xác nhận
                const cancelModal = new bootstrap.Modal(document.getElementById('cancelConfirmModal'));
                cancelModal.show();
                // Đẩy lại state để ngăn back tiếp
                window.history.pushState({form: true}, '');
            } else {
                // Nếu không có dữ liệu, cho phép quay lại trang danh sách
                window.location.href = '/Admin/order';
            }
        });

        // Xử lý nút xác nhận hủy
        document.getElementById('confirmCancelBtn').onclick = function() {
            sessionStorage.removeItem("selectedProduct");
            sessionStorage.removeItem("selectedCustomer");
            sessionStorage.removeItem("selectedNewCustomer");
            window.location.href = '/Admin/order';
        };

        // Khởi tạo các chức năng chính
        initializeOrderCode();
        handlePageNavigation();
        loadCustomerData();
        loadProductData();
        initializeEventListeners();
        calculateTotal();
    });

    // Khởi tạo mã đơn hàng
    function initializeOrderCode() {
        document.getElementById("orderCode").value = "Tự sinh khi lưu";

        fetch('/Admin/order/next-code')
            .then(response => response.text())
            .then(nextCode => {
                document.getElementById("orderCode").value = nextCode;
            })
            .catch(error => {
                console.error('Error fetching next order code:', error);
                document.getElementById("orderCode").value = "Tự sinh khi lưu";
            });
    }
    // Xử lý điều hướng trang
    function handlePageNavigation() {
        // Kiểm tra nguồn quay lại
        const referrer = document.referrer;

        if (performance.getEntriesByType("navigation")[0]?.type === "reload") {
            sessionStorage.clear();
            localStorage.clear();
            console.log("Reloaded - storage cleared");
        }

        // Nếu quay lại từ trang danh sách đơn hàng
        if (referrer.includes('/Admin/order') && !referrer.includes('/Admin/order/showListProduct')) {
            sessionStorage.removeItem("selectedProduct");
            sessionStorage.removeItem("selectedCustomer");
            sessionStorage.removeItem("selectedNewCustomer");
            localStorage.removeItem("selectedProduct");
            // Reset form
            $('#orderForm')[0].reset();
            $('#productList').empty();
            $('#noProductsMessage').show();
            calculateTotal();
        }
        // Nếu quay lại từ trang chọn sản phẩm
        else if (referrer.includes('/Admin/order/showListProduct')) {
            const selectedProduct = localStorage.getItem("selectedProduct") || sessionStorage.getItem("selectedProduct");
            if (selectedProduct) {
                try {
                    let products = JSON.parse(selectedProduct);
                    $('#productList').empty();
                    products.forEach(function(product, index) {
                        addProductRow(product, index);
                    });
                    calculateTotal();
                } catch (e) {
                    console.error("Error processing selected products:", e);
                }
            }
        }
        else {
            // Xóa dữ liệu cũ
            sessionStorage.removeItem("selectedProduct");
            localStorage.removeItem("selectedProduct");
        }

        // Thêm state vào history khi trang được tải
        if (window.history && window.history.pushState) {
            window.history.pushState({form: true}, '');
        }
    }

    // Khởi tạo các events listener
    function initializeEventListeners() {
        $('#selectCustomerBtn').on('click', function() {
            window.location.href = "/Admin/order/showListCustomer";
        });

        $('#cancelBtn').on('click', function() {
            const cancelModal = new bootstrap.Modal(document.getElementById('cancelConfirmModal'));
            cancelModal.show();
        });

        $('#confirmCancelBtn').on('click', function() {
            sessionStorage.removeItem("selectedProduct");
            sessionStorage.removeItem("selectedCustomer");
            sessionStorage.removeItem("selectedNewCustomer");
            window.location.href = "/Admin/order";
        });

        // Gắn sự kiện cho nút thêm sản phẩm
        $('#addProductButton').on('click', function() {
            selectProductWithValidation();
        });

        // Form submission handling
        $("#orderForm").submit(handleFormSubmission);
    }

    // Tải dữ liệu KH từ storage
    function loadCustomerData() {
        let selectedCustomer;
        if(localStorage.getItem("selectedCustomer") == null && sessionStorage.getItem("selectedNewCustomer") == null){
            selectedCustomer = sessionStorage.getItem("selectedCustomer");
        } else if(sessionStorage.getItem("selectedNewCustomer") != null && localStorage.getItem("selectedCustomer") == null){
            selectedCustomer = sessionStorage.getItem("selectedNewCustomer");
            sessionStorage.removeItem("selectedNewCustomer");
        } else {
            selectedCustomer = localStorage.getItem("selectedCustomer");
        }

        if (selectedCustomer) {
            let customer = JSON.parse(selectedCustomer);
            document.getElementById("customerId").value = customer.id;
            document.getElementById("customerName").value = customer.name;
            document.getElementById("customerPhoneNumber").value = customer.phone;
            document.getElementById("customerAddress").value = customer.address;
            document.getElementById("customerEmail").value = customer.email;
            document.getElementById("customerBirthdate").value = formatDateToDisplay(customer.birthdate);
            if (customer.code) {
                document.getElementById("customerCode").value = customer.code;
                document.getElementById("customerCodeHidden").value = customer.code;
            } else {
                document.getElementById("customerCode").value = "Tự sinh khi lưu";
                document.getElementById("customerCodeHidden").value = "";
            }
            localStorage.removeItem("selectedCustomer");
            sessionStorage.setItem("selectedCustomer", JSON.stringify(customer));
            if (customer.id) {
                document.getElementById("customerName").readOnly = true;
                document.getElementById("customerPhoneNumber").readOnly = true;
                document.getElementById("customerAddress").readOnly = true;
                document.getElementById("customerEmail").readOnly = true;
                document.getElementById("customerBirthdate").readOnly = true;
            }
        }

        initializeCustomerCode();
    }

    // cập nhập tồn kho
    function loadProductData() {
        console.log("Checking for product data in storage...");
        console.log("localStorage.selectedProduct:", localStorage.getItem("selectedProduct"));
        console.log("sessionStorage.selectedProduct:", sessionStorage.getItem("selectedProduct"));

        let selectedProduct;
        if(localStorage.getItem("selectedProduct") == null){
            selectedProduct = sessionStorage.getItem("selectedProduct");
            console.log("Using product data from sessionStorage");
        } else {
            selectedProduct = localStorage.getItem("selectedProduct");
            console.log("Using product data from localStorage");
        }

        if (selectedProduct) {
            console.log("Found selected products:", selectedProduct);
            try {
                let products = JSON.parse(selectedProduct);
                console.log("Products parsed:", products);
                $('#productList').empty();

                if (products && Array.isArray(products) && products.length > 0) {
                    console.log("First product details:", JSON.stringify(products[0], null, 2));
                    products.forEach(function(product, index) {
                        console.log(`Processing product at index ${index}:`, product);

                        // Kiểm tra tính đầy đủ của dữ liệu sản phẩm
                        if (!product.productId) {
                            console.error(`Product at index ${index} missing productId:`, product);
                        }

                        // Check and map product price field
                        if (product.price === undefined && product.productPrice !== undefined) {
                            product.price = product.productPrice;
                            console.log(`Mapped productPrice to price: ${product.price}`);
                        }
                        product.quantity = Math.max(1, parseInt(product.quantity) || 1);
                        console.log(`Set quantity to ${product.quantity}`);
                        addProductRow(product, index);
                    });

                    calculateTotal();
                    localStorage.removeItem("selectedProduct");
                    sessionStorage.setItem("selectedProduct", JSON.stringify(products));
                    updateProductSectionDisplay();
                } else {
                    console.error("Products object is not valid:", products);
                }
            } catch (e) {
                console.error("Error parsing selected products:", e);
                console.error("Raw selected products data:", selectedProduct);
            }
        } else {
            console.log("No product data found in storage");
        }
    }
    // Lấy tồn kho hiện tại của một sản phẩm
    async function fetchCurrentStock(productId) {
        try {
            const response = await fetch(`/api/products/stock/${productId}`);
            if (response.ok) {
                const data = await response.json();
                return data.stock || 0;
            } else {
                console.error(`Lỗi khi lấy tồn kho cho sản phẩm ${productId}:`, response.statusText);
            }
        } catch (error) {
            console.error('Lỗi khi gọi API lấy tồn kho:', error);
        }
        return 0;
    }

    // Cập nhật tồn kho cho tất cả sản phẩm đã chọn
    async function updateStockForAllSelectedProducts(products) {
        const productIds = products.map(p => p.productId);

        try {
            const response = await fetch('/api/products/stock/batch', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(productIds)
            });

            if (response.ok) {
                const data = await response.json();
                const stockMap = data.stocks;

                // Cập nhật tồn kho cho từng sản phẩm
                products.forEach(product => {
                    if (stockMap[product.productId] && stockMap[product.productId].exists) {
                        product.stockQuantity = stockMap[product.productId].stock;
                        product.productName = stockMap[product.productId].productName;
                        product.price = stockMap[product.productId].price;
                    } else {
                        console.warn(`Không tìm thấy thông tin tồn kho cho sản phẩm ID: ${product.productId}`);
                        product.stockQuantity = 0;
                    }
                });
            } else {
                console.error('Lỗi khi gọi API batch stock:', response.statusText);
            }
        } catch (error) {
            console.error('Lỗi khi cập nhật tồn kho batch:', error);
        }

        return products;
    }

    // Kiểm tra tồn kho trước khi submit đơn hàng
    async function validateStockBeforeSubmit() {
        const items = [];

        $('.product-row').each(function() {
            const $row = $(this);
            const productId = parseInt($row.find('.productId').val());
            const quantity = parseInt($row.find('.quantity-input').val());

            if (productId && quantity > 0) {
                items.push({
                    productId: productId,
                    quantity: quantity
                });
            }
        });

        if (items.length === 0) {
            return { isValid: false, message: "Không có sản phẩm nào để kiểm tra" };
        }

        try {
            const response = await fetch('/api/products/stock/validate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ items: items })
            });

            const data = await response.json();

            if (!data.isValid) {
                showStockErrorModal(data.invalidItems.map(item => ({
                    name: item.productName || `Sản phẩm ID: ${item.productId}`,
                    requested: item.requestedQuantity,
                    available: item.availableStock
                })));

                // Đánh dấu các input không hợp lệ - CHỈ THÊM CLASS, KHÔNG TEXT
                data.invalidItems.forEach(item => {
                    $('.product-row').each(function() {
                        const $row = $(this);
                        const productId = parseInt($row.find('.productId').val());

                        if (productId === item.productId) {
                            const $quantityInput = $row.find('.quantity-input');
                            $quantityInput.addClass('is-invalid');
                            $quantityInput.data('stock', item.availableStock);
                            $quantityInput.attr('data-stock', item.availableStock);
                        }
                    });
                });
            }

            return data;
        } catch (error) {
            console.error('Lỗi khi kiểm tra tồn kho:', error);
            return { isValid: false, message: "Lỗi khi kiểm tra tồn kho: " + error.message };
        }
    }
    // Cập nhật tồn kho cho tất cả sản phẩm hiện tại
    function updateAllProductStock() {
        $('.product-row').each(function() {
            const $row = $(this);
            const $quantityInput = $row.find('.quantity-input');
            const productId = $quantityInput.data('product-id');

            if (productId) {
                fetchCurrentStock(productId).then(currentStock => {
                    $quantityInput.data('stock', currentStock);
                    $quantityInput.attr('data-stock', currentStock);
                    validateStockQuantity($quantityInput[0]);
                });
            }
        });
    }
    function addProductRow(product, index) {
        console.log(`Adding product row ${index}:`, product);
        const row = $('<tr class="product-row"></tr>');
        let price = 0;
        if (product.price !== undefined) {
            price = parseFloat(product.price);
        } else if (product.productPrice !== undefined) {
            price = parseFloat(product.productPrice);
        } else if (product.priceIndex !== undefined) {
            price = parseFloat(product.priceIndex);
        }
        const quantity = Math.max(1, parseInt(product.quantity) || 1);

        // Xử lý tồn kho
        let stockQuantity = 0;
        if (product.stockQuantity !== undefined && product.stockQuantity !== null) {
            stockQuantity = parseInt(product.stockQuantity);
        } else if (product.stock !== undefined && product.stock !== null) {
            stockQuantity = parseInt(product.stock);
        } else if (product.remainingStock !== undefined && product.remainingStock !== null) {
            stockQuantity = parseInt(product.remainingStock);
        }

        if (isNaN(stockQuantity) || stockQuantity < 0) {
            stockQuantity = 0;
        }

        console.log(`Product ${product.productName}: stockQuantity = ${stockQuantity}`);

        const rawPrice = Math.round(price);
        const rowTotal = rawPrice * quantity;
        const formattedPrice = formatCurrency(rawPrice);
        const productName = product.productName || 'Sản phẩm không có tên';

        const isOverStock = quantity > stockQuantity;

        row.html(`
<td class="stt-column">${index + 1}</td>
<td>
    <input type="hidden" name="productOrderDTOList[${index}].productId" value="${product.productId}" class="productId">
    <input type="text" class="form-control bg-light form-control-sm" name="productOrderDTOList[${index}].productName" value="${productName}" readonly>
</td>
<td>
    <div class="position-relative">
        <input type="number" name="productOrderDTOList[${index}].quantity" class="form-control quantity-input form-control-sm text-center ${isOverStock ? 'is-invalid' : ''}"
               value="${quantity}" required min="1" step="1" data-stock="${stockQuantity}" data-product-id="${product.productId}"
               onchange="validateStockQuantity(this); calculateTotal();"
               oninput="validateStockQuantity(this);">
    </div>
</td>
<td>
    <input type="hidden" name="productOrderDTOList[${index}].priceIndex" value="${rawPrice}" class="raw-price-input">
    <input type="text" class="form-control price-display form-control-sm text-end" value="${formattedPrice}" readonly>
</td>
<td>
    <input type="text" class="form-control bg-light row-total form-control-sm text-end"
           value="${formatCurrency(rowTotal)}" readonly>
</td>
<td class="text-center action-column">
    <button type="button" class="delete-btn" onclick="removeProduct(this)" title="Xóa sản phẩm này">
        <i class="fas fa-times"></i>
    </button>
</td>
`);

        $('#productList').append(row);
        validateStockQuantity(row.find('.quantity-input')[0]);
        updateProductSectionDisplay();
        $('#noProductsMessage').hide();

        // Lấy thông tin tồn kho mới nhất từ server
        fetchCurrentStock(product.productId).then(currentStock => {
            if (currentStock !== stockQuantity) {
                console.log(`Cập nhật tồn kho cho sản phẩm ${product.productId}: ${stockQuantity} -> ${currentStock}`);
                const $input = row.find('.quantity-input');
                $input.data('stock', currentStock);
                $input.attr('data-stock', currentStock);

                // ===== CHỈ VALIDATE LẠI, KHÔNG CẬP NHẬT TEXT HIỂN THỊ =====
                validateStockQuantity($input[0]);
            }
        });
    }

    // Xóa sản phẩm khỏi danh sách
    function removeProduct(button) {
        const row = $(button).closest('tr');
        const productId = row.find('.productId').val();
        console.log(`Removing product with ID ${productId}`);
        row.remove();
        $('#productList tr.product-row').each(function(index) {
            $(this).find('td:first-child').text(index + 1);

            $(this).find('input, select').each(function() {
                const name = $(this).attr('name');
                if (name) {
                    const newName = name.replace(/\[\d+\]/, '[' + index + ']');
                    $(this).attr('name', newName);
                }
            });
        });
        try {
            const selectedProducts = JSON.parse(sessionStorage.getItem("selectedProduct") || "[]");
            const updatedProducts = selectedProducts.filter(product => product.productId != productId);
            console.log(`Filtered products array - Before: ${selectedProducts.length}, After: ${updatedProducts.length}`);
            sessionStorage.setItem("selectedProduct", JSON.stringify(updatedProducts));
        } catch (e) {
            console.error("Error updating sessionStorage after product removal:", e);
        }

        if ($('#productList tr.product-row').length === 0) {
            $('#noProductsMessage').show();
        } else {
            $('#noProductsMessage').hide();
        }
        calculateTotal();
        updateProductSectionDisplay();
    }

    // Cập nhật hiển thị phần sản phẩm
    function updateProductSectionDisplay() {
        const productRows = $('#productList tr.product-row').length;
        console.log(`updateProductSectionDisplay called: ${productRows} products`);
        if (productRows > 0) {
            $('#productSection').show();
            $('#noProductsSection').hide();
        } else {
            $('#productSection').hide();
            $('#noProductsSection').show();
        }
    }

    // Kiểm tra số lượng so với tồn kho
    function validateStockQuantity(input) {
        const $input = $(input);
        const value = parseInt($input.val());
        let stockQuantity = parseInt($input.data('stock'));

        if (isNaN(stockQuantity)) {
            stockQuantity = parseInt($input.attr('data-stock'));
        }

        if (isNaN(stockQuantity)) {
            stockQuantity = 0;
            console.warn('Không tìm thấy thông tin tồn kho cho sản phẩm này');
        }

        console.log(`Validating stock: value=${value}, stockQuantity=${stockQuantity}`);

        if (isNaN(value) || value < 1) {
            $input.val(1);
            $input.removeClass('is-invalid');
            return true;
        }

        if (value > stockQuantity) {
            $input.addClass('is-invalid');
            return false;
        } else {
            $input.removeClass('is-invalid');
            return true;
        }
    }


    // Kiểm tra tất cả sản phẩm trong đơn hàng trước khi gửi
    function validateAllStockQuantities() {
        let isValid = true;
        const invalidProducts = [];

        $('.product-row').each(function() {
            const $row = $(this);
            const $quantityInput = $row.find('.quantity-input');
            const quantity = parseInt($quantityInput.val());
            const stockQuantity = parseInt($quantityInput.data('stock'));
            const productName = $row.find('input[name$=".productName"]').val();

            if (quantity > stockQuantity) {
                $quantityInput.addClass('is-invalid');
                invalidProducts.push({
                    name: productName,
                    requested: quantity,
                    available: stockQuantity
                });
                isValid = false;
            }
        });

        if (!isValid) {
            showStockErrorModal(invalidProducts);
        }

        return isValid;
    }

    // Hiển thị modal thông báo lỗi tồn kho
    function showStockErrorModal(products) {
        let productList = '';

        products.forEach(function(product) {
            productList += `<li class="mb-2"><strong>${product.name}</strong>: Đã đặt ${product.requested} sản phẩm nhưng chỉ còn ${product.available} trong kho</li>`;
        });

        const modalContent = `
        <div class="alert alert-danger">
            <p class="mb-2">Các sản phẩm sau vượt quá số lượng tồn kho:</p>
            <ul class="mb-0">${productList}</ul>
        </div>
        <p class="mb-0">Vui lòng điều chỉnh số lượng đặt hàng trước khi tiếp tục.</p>
    `;

        $('#stockErrorModalBody').html(modalContent);
        const stockErrorModal = new bootstrap.Modal(document.getElementById('stockErrorModal'));
        stockErrorModal.show();
    }

    // Ensure quantity doesn't go below 1
    function validateQuantity(input) {
        let value = parseInt($(input).val());
        if (isNaN(value) || value < 1) {
            $(input).val(1);
            value = 1;
        }

        // Kiểm tra tồn kho
        validateStockQuantity(input);

        calculateTotal();
    }

    // Format currency with commas
    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN').format(amount);
    }

    // Format input currency
    function formatInputCurrency(input) {
        const value = $(input).val();
        const cleanValue = value.replace(/[^\d]/g, '');
        const formattedValue = formatCurrency(cleanValue);
        $(input).val(formattedValue);
    }

    // Calculate total price
    function calculateTotal() {
        let totalAmount = 0;
        let totalQuantity = 0;

        // Calculate row totals and update display
        $('.product-row').each(function() {
            const quantity = parseInt($(this).find('.quantity-input').val()) || 0;
            // Sử dụng giá trị số nguyên từ trường ẩn
            const price = parseInt($(this).find('.raw-price-input').val()) || 0;
            const rowTotal = quantity * price;

            $(this).find('.row-total').val(formatCurrency(rowTotal));

            totalQuantity += quantity;
            totalAmount += rowTotal;
        });

        console.log(`Calculate total - Total quantity: ${totalQuantity}, Total amount: ${totalAmount}`);

        // Update displayed totals
        $('#totalQuantity').text(totalQuantity);
        $('#totalAmount').text(formatCurrency(totalAmount));

        // Apply discounts
        const discountAmountStr = $('#discountAmount').val().replace(/[^\d]/g, '') || '0';
        const discountAmount = parseInt(discountAmountStr) || 0;
        const discountPercent = parseFloat($('#discountPercent').val()) || 0;

        let totalDiscount = discountAmount;
        if (discountPercent > 0) {
            totalDiscount += Math.round(totalAmount * discountPercent / 100);
        }

        console.log(`Discounts - Amount: ${discountAmount}, Percent: ${discountPercent}%, Total discount: ${totalDiscount}`);

        // Calculate final total
        const grandTotal = Math.max(0, totalAmount - totalDiscount);

        // Update grand total display and hidden input
        $('#grandTotal').text(formatCurrency(grandTotal));
        $('#total').val(grandTotal);

        console.log(`Grand total: ${grandTotal}`);
    }
    // Chuyển đổi định dạng ngày
    function formatDateToDisplay(dateStr) {
        if (!dateStr) return '';

        // Nếu đã ở định dạng dd/MM/yyyy thì giữ nguyên
        if (dateStr.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
            return dateStr;
        }

        // Chuyển từ yyyy-MM-dd sang dd/MM/yyyy
        if (dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
            const parts = dateStr.split('-');
            return parts[2] + '/' + parts[1] + '/' + parts[0];
        }

        return dateStr;
    }

    // Khởi tạo mã khách hàng
    function initializeCustomerCode() {
        if (!document.getElementById("customerId").value &&
            (!document.getElementById("customerCode").value ||
                document.getElementById("customerCode").value === "Tự sinh khi lưu")) {

            document.getElementById("customerCode").value = "Tự sinh khi lưu";
            document.getElementById("customerCodeHidden").value = "";

            fetch('/Admin/customers/next-code')
                .then(response => response.text())
                .then(nextCode => {
                    if (!document.getElementById("customerId").value) {
                        document.getElementById("customerCode").value = nextCode;
                        document.getElementById("customerCodeHidden").value = nextCode;
                    }
                })
                .catch(error => {
                    console.error('Error fetching next customer code:', error);
                    if (!document.getElementById("customerId").value) {
                        document.getElementById("customerCode").value = "Tự sinh khi lưu";
                    }
                });
        }
    }

    function selectProductWithValidation() {
        console.log("selectProductWithValidation called");
        const customerId = document.getElementById('customerId').value;
        if (customerId) {
            selectProduct();
            return;
        }
        const nameInput = document.getElementById('customerName');
        const phoneInput = document.getElementById('customerPhoneNumber');
        const addressInput = document.getElementById('customerAddress');
        const emailInput = document.getElementById('customerEmail');

        document.querySelectorAll('.error').forEach(error => {
            error.textContent = '';
            error.style.display = 'none';
        });

        let isValid = true;

        // Kiểm tra tên khách hàng
        if (!nameInput.value.trim()) {
            const errorElement = document.getElementById('customerNameError') ||
                document.querySelector('.error[for="customerName"]');
            if (errorElement) {
                errorElement.textContent = 'Tên không được để trống';
                errorElement.style.display = 'block';
            } else {
                const newError = document.createElement('p');
                newError.className = 'error text-danger';
                newError.id = 'customerNameError';
                newError.textContent = 'Tên không được để trống';
                nameInput.parentNode.appendChild(newError);
            }
            isValid = false;
        }

        // Kiểm tra số điện thoại
        if (!phoneInput.value.trim()) {
            const errorElement = document.getElementById('phoneNumberError') ||
                document.querySelector('.error[for="customerPhoneNumber"]');
            if (errorElement) {
                errorElement.textContent = 'Số điện thoại không được để trống';
                errorElement.style.display = 'block';
            } else {
                const newError = document.createElement('p');
                newError.className = 'error text-danger';
                newError.id = 'phoneNumberError';
                newError.textContent = 'Số điện thoại không được để trống';
                phoneInput.parentNode.appendChild(newError);
            }
            isValid = false;
        }

        // Kiểm tra địa chỉ
        if (!addressInput.value.trim()) {
            const errorElement = document.getElementById('addressError') ||
                document.querySelector('.error[for="customerAddress"]');
            if (errorElement) {
                errorElement.textContent = 'Địa chỉ không được để trống';
                errorElement.style.display = 'block';
            } else {
                const newError = document.createElement('p');
                newError.className = 'error text-danger';
                newError.id = 'addressError';
                newError.textContent = 'Địa chỉ không được để trống';
                addressInput.parentNode.appendChild(newError);
            }
            isValid = false;
        }

        // Kiểm tra email
        if (!emailInput.value.trim()) {
            const errorElement = document.getElementById('emailError') ||
                document.querySelector('.error[for="customerEmail"]');
            if (errorElement) {
                errorElement.textContent = 'Email không được để trống';
                errorElement.style.display = 'block';
            } else {
                const newError = document.createElement('p');
                newError.className = 'error text-danger';
                newError.id = 'emailError';
                newError.textContent = 'Email không được để trống';
                emailInput.parentNode.appendChild(newError);
            }
            isValid = false;
        }

        if (!isValid) {
            // Hiển thị modal thông báo cần điền đầy đủ thông tin khách hàng
            const customerRequiredModal = new bootstrap.Modal(document.getElementById('customerRequiredModal'));
            customerRequiredModal.show();
            return;
        }

        // Thông tin khách hàng hợp lệ, tiếp tục chọn sản phẩm
        selectProduct();
    }

    function selectProduct() {
        console.log("Select product button clicked");

        // Save customer data
        let customerId = $('#customerId').val();
        if (customerId == "") {
            let customerName = $('#customerName').val();
            let customerPhoneNumber = $('#customerPhoneNumber').val();
            let customerAddress = $('#customerAddress').val();
            let customerEmail = $('#customerEmail').val();
            let customerBirthdate = $('#customerBirthdate').val();
            let customerCode = $('#customerCode').val();

            if (!customerName || !customerPhoneNumber || !customerEmail || !customerAddress) {
                // Hiển thị modal thông báo
                const customerRequiredModal = new bootstrap.Modal(document.getElementById('customerRequiredModal'));
                customerRequiredModal.show();
                return;
            }

            let customerData = {
                id: customerId,
                name: customerName,
                phone: customerPhoneNumber,
                address: customerAddress,
                email: customerEmail,
                birthdate: customerBirthdate,
                code: customerCode !== "Tự sinh khi lưu" ? customerCode : ""
            };
            sessionStorage.setItem("selectedNewCustomer", JSON.stringify(customerData));
            console.log("Saved new customer data to sessionStorage", customerData);
        }

        // ===== LƯU THÔNG TIN TỒN KHO HIỆN TẠI TRƯỚC KHI CHUYỂN TRANG =====
        let currentProducts = [];
        $('.product-row').each(function() {
            const $row = $(this);
            const productId = $row.find('.productId').val();
            const quantity = $row.find('.quantity-input').val() || 1;
            const stockQuantity = $row.find('.quantity-input').data('stock') || 0;

            if (productId) {
                currentProducts.push({
                    productId: productId,
                    quantity: quantity,
                    stockQuantity: stockQuantity // Lưu thông tin tồn kho
                });
            }
        });

        if (currentProducts.length > 0) {
            sessionStorage.setItem("currentProductsWithStock", JSON.stringify(currentProducts));
        }

        // Create string of product IDs and quantities
        let productIdAndQuantity = [];
        $('.product-row').each(function() {
            const productId = $(this).find('.productId').val();
            const quantity = $(this).find('.quantity-input').val() || 1;

            if (productId) {
                productIdAndQuantity.push(productId + '.' + quantity);
            }
        });

        let productIdAndQuantityToString = productIdAndQuantity.join('-');
        console.log("Product IDs and quantities:", productIdAndQuantityToString);

        // Redirect to product selection page
        window.location.href = "/Admin/order/showListProduct" + (productIdAndQuantityToString ? "?oldData=" + productIdAndQuantityToString : "");
    }

    async function handleFormSubmission(event) {
        event.preventDefault();

        const stockValidation = await validateStockBeforeSubmit();
        if (!stockValidation.isValid) {
            console.log("Tồn kho không hợp lệ, dừng submit");
            return false;
        }

        // Xử lý ngày sinh trước khi submit
        const birthDateInput = document.getElementById('customerBirthdate');
        if (birthDateInput && birthDateInput.value) {
            try {
                console.log("Submitting birthdate in format dd/MM/yyyy:", birthDateInput.value);
            } catch (e) {
                console.error("Error formatting birthdate:", e);
                $('#birthDateError').text("Ngày sinh không hợp lệ").show();
                return;
            }
        }

        if (document.getElementById("customerCode").value === "Tự sinh khi lưu") {
            document.getElementById("customerCodeHidden").value = "";
        } else {
            document.getElementById("customerCodeHidden").value = document.getElementById("customerCode").value;
        }

        // Kiểm tra xem có sản phẩm không
        if ($('#productList tr.product-row').length === 0) {
            $('#noProductsMessage').html('<span class="error" style="font-weight: 500;!important;">Vui lòng thêm ít nhất một sản phẩm</span>');
            $('#noProductsMessage').show();
            return;
        }

        let formData = $(this).serialize();
        console.log("Submitting form data:", formData);

        $.post({
            url: "/Admin/order/create",
            data: formData,
            success: function(response) {
                try {
                    if (typeof response === 'string') {
                        response = JSON.parse(response);
                    }

                    console.log("Server response:", response);

                    if (response.paymentMethod == 1) {
                        // Hiển thị modal QR code
                        const qrModal = new bootstrap.Modal(document.getElementById('qrPaymentModal'));
                        // Lấy thông tin từ response hoặc từ form nếu thiếu
                        const codeOrder = response.codeOrder || response.invoiceNumber || document.getElementById('orderCode').value;
                        const customerName = response.customerName || document.getElementById('customerName').value;
                        const customerPhone = response.customerPhone || document.getElementById('customerPhoneNumber').value;
                        let totalPrice = response.totalPrice || document.getElementById('total').value || 0;
                        if (typeof totalPrice === 'string') totalPrice = parseInt(totalPrice.replace(/[^\d]/g, '')) || 0;
                        document.getElementById('orderCodeDisplay').textContent = codeOrder;
                        document.getElementById('customerNameDisplay').textContent = customerName;
                        document.getElementById('customerPhoneDisplay').textContent = customerPhone;
                        document.getElementById('paymentAmount').textContent = formatCurrency(totalPrice);
                        document.getElementById('paymentContent').textContent = 'THANH TOAN DH ' + codeOrder;
                        let tenMinutes = 60 * 10;
                        let display = document.querySelector('#countdown');
                        startTimer(tenMinutes, display);
                        // Hiển thị modal
                        qrModal.show();
                        // Xử lý nút xác nhận thanh toán
                        document.getElementById('confirmPaymentBtn').onclick = function() {
                            // Gọi API xác nhận thanh toán
                            fetch('/Admin/payment/confirm-payment', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                },
                                body: `orderId=${response.orderId}&paymentId=${response.paymentId}`
                            })
                                .then(response2 => {
                                    if (response2.ok) {
                                        // In hóa đơn trước khi chuyển trang
                                        window.open("/Admin/order/downloadInvoicePdf?orderId=" + response.orderId, "_blank");
                                        window.location.href = "/Admin/order?successMessage=" + encodeURIComponent("Thêm đơn hàng mới thành công.");
                                    } else {
                                        return response2.text().then(text => {
                                            throw new Error(text);
                                        });
                                    }
                                })
                                .catch(error => {
                                    console.error("Lỗi khi xác nhận thanh toán:", error.message);
                                    window.location.href = "/Admin/order?errorMessage=" + encodeURIComponent("Lỗi khi xác nhận thanh toán: " + error.message);
                                });
                        };
                    } else {
                        // Nếu thanh toán tiền mặt, in hóa đơn trước khi chuyển hướng
                        window.open("/Admin/order/downloadInvoicePdf?orderId=" + response.orderId, "_blank");
                        window.location.href = "/Admin/order?successMessage=Thêm đơn hàng mới thành công!";
                    }

                    // Clear storage
                    sessionStorage.removeItem("selectedProduct");
                    sessionStorage.removeItem("selectedCustomer");
                    sessionStorage.removeItem("selectedNewCustomer");
                } catch (e) {
                    console.error("Error processing response:", e, "Raw response:", response);
                    console.error("Lỗi khi xử lý phản hồi từ máy chủ");
                }
            },
            error: function(xhr) {
                console.error("Form submission error:", xhr);
                if (xhr.status === 400) {
                    let errors = xhr.responseJSON;
                    console.log("Validation errors:", errors);
                    $(".error-message").remove();

                    for (let field in errors) {
                        let errorMessage = "<span class='error-message text-danger'>" + errors[field] + "</span>";
                        $('input[name="' + field + '"], select[name="' + field + '"], textarea[name="' + field + '"]').after(errorMessage);
                    }
                } else if (xhr.responseText && xhr.responseText.includes("không đủ số lượng trong kho")) {
                    // Xử lý lỗi tồn kho từ server
                    try {
                        const errorMsg = xhr.responseText;
                        // Trích xuất thông tin sản phẩm và tồn kho từ lỗi
                        const regex = /Sản phẩm (.*?) không đủ số lượng trong kho\. Hiện chỉ còn (\d+) sản phẩm/;
                        const match = errorMsg.match(regex);

                        if (match) {
                            const productName = match[1];
                            const availableStock = parseInt(match[2]);

                            // Tìm sản phẩm trong bảng và cập nhật số lượng tồn kho
                            $('.product-row').each(function() {
                                const $row = $(this);
                                if ($row.find('input[name$=".productName"]').val() === productName) {
                                    const $quantityInput = $row.find('.quantity-input');
                                    $quantityInput.data('stock', availableStock);
                                    $quantityInput.attr('data-stock', availableStock);

                                    // Đánh dấu lỗi
                                    $quantityInput.addClass('is-invalid');
                                }
                            });

                            // Hiển thị modal lỗi
                            showStockErrorModal([{
                                name: productName,
                                requested: parseInt($('.product-row').find(`.quantity-input.is-invalid`).val()),
                                available: availableStock
                            }]);
                        } else {
                            // Hiển thị thông báo lỗi chung
                            $('#stockErrorModalBody').html(`
                            <div class="alert alert-danger">
                                <p class="mb-0">${errorMsg}</p>
                            </div>
                        `);
                            const stockErrorModal = new bootstrap.Modal(document.getElementById('stockErrorModal'));
                            stockErrorModal.show();
                        }
                    } catch (e) {
                        console.error("Lỗi khi xử lý phản hồi lỗi tồn kho:", e);
                    }
                } else {
                    // Hiển thị lỗi chung
                    console.error("Lỗi khi gửi yêu cầu:", xhr.statusText);
                    $('#stockErrorModalBody').html(`
                    <div class="alert alert-danger">
                        <p class="mb-0">Đã xảy ra lỗi khi tạo đơn hàng: ${xhr.responseText || xhr.statusText || "Lỗi không xác định"}</p>
                    </div>
                `);
                    const stockErrorModal = new bootstrap.Modal(document.getElementById('stockErrorModal'));
                    stockErrorModal.show();
                }
            }
        });
    }
    // Thêm các hàm xử lý thanh toán QR
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            alert("Đã sao chép: " + text);
        }, function() {
            alert("Không thể sao chép văn bản");
        });
    }

    function startTimer(duration, display) {
        let timer = duration, minutes, seconds;
        let countdown = setInterval(function () {
            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);

            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            display.textContent = minutes + ":" + seconds;

            if (--timer < 0) {
                clearInterval(countdown);
                display.textContent = "00:00";
                alert("Thời gian thanh toán đã hết. Vui lòng tạo đơn hàng mới.");
                $('#qrPaymentModal').modal('hide');
            }
        }, 1000);
    }
</script>
<script th:src="@{/js/admin/orderValidation.js}"></script>
</body>
</html>