<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tạo Đơn Hàng</title>
    <link rel="stylesheet" th:href="@{/css/admin/fragments/sidebar.css}">
    <link rel="stylesheet" th:href="@{/css/admin/fragments/header.css}">
    <link rel="stylesheet" th:href="@{/css/admin/fragments/footer.css}">
    <link rel="stylesheet" th:href="@{/css/admin/layout/layout.css}">
    <link rel="stylesheet" th:href="@{/css/admin/layout/tablelayout.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        .form-container { background-color: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 20px; position: relative; }
        .product-table th { background-color: #212529; color: white; padding: 10px; text-align: center; vertical-align: middle;}
        .product-table td { padding: 8px; vertical-align: middle; }
        .totals-container { background-color: #f8f9fa; border-radius: 5px; padding: 15px; margin-bottom: 20px; position: relative; }
        .btn-action { border-radius: 4px; padding: 10px 20px; font-weight: 600; margin-top: 10px; }
        .red-bar { background-color: #dc3545; width: 4px; height: 100%; position: absolute; left: 0; top: 0; }
        .delete-btn { padding: 2px 6px; background-color: #dc3545; color: white; border: none; border-radius: 4px; }
        .validation-message { font-size: 0.875em; margin-top: .25rem; display: block; }
        .text-end { text-align: right !important; }
        #productModal .table th, #productModal .table td { vertical-align: middle; }
        #productModal .table th:first-child, #productModal .table td:first-child { text-align: center; }
    </style>
</head>
<body>
<div th:replace="~{admin/fragments/header :: header}"></div>
<div th:replace="~{admin/fragments/sidebar :: sidebar}"></div>

<main class="main-content">
    <div class="wrapper">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="tittle">Tạo Đơn Hàng</h1>
            <a th:href="@{/Admin/order}" class="btn btn-secondary">
                Quay lại
            </a>
        </div>

        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>

        <form id="orderForm" th:action="@{/Admin/order/create}" method="POST" th:object="${orderDTO}" class="needs-validation" novalidate>
            <!-- Thông tin đơn hàng -->
            <div class="form-container position-relative mb-3">
                <div class="red-bar"></div>
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="orderCode" class="form-label">Mã Đơn Hàng</label>
                        <input type="text" class="form-control bg-light" id="orderCode" name="orderCode" th:field="*{invoiceNumber}" readonly>
                    </div>
                </div>
            </div>

            <!-- Thông tin khách hàng -->
            <div class="form-container position-relative mb-3">
                <div class="red-bar"></div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">Thông Tin Khách Hàng</h5>
                    <button type="button" class="btn btn-primary" id="selectCustomerBtn">
                        <i class="fas fa-users me-1"></i> Chọn khách hàng
                    </button>
                </div>

                <input type="hidden" th:field="*{customerDTO.customerId}" id="customerId">

                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="customerName" class="form-label">Tên Khách Hàng <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="customerName" name="customerName" th:field="*{customerDTO.customerName}" required>
                        <p class="error text-danger" th:if="${#fields.hasErrors('customerDTO.customerName')}" th:errors="*{customerDTO.customerName}"></p>
                    </div>
                    <div class="col-md-4">
                        <label for="customerPhoneNumber" class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="customerPhoneNumber" name="customerPhoneNumber" th:field="*{customerDTO.phoneNumber}" required>
                        <p class="error text-danger" th:if="${#fields.hasErrors('customerDTO.phoneNumber')}" th:errors="*{customerDTO.phoneNumber}"></p>
                    </div>
                    <div class="col-md-4">
                        <label for="customerEmail" class="form-label">Email <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" id="customerEmail" name="customerEmail" th:field="*{customerDTO.email}" required>
                        <p class="error text-danger" th:if="${#fields.hasErrors('customerDTO.email')}" th:errors="*{customerDTO.email}"></p>
                    </div>
                    <div class="col-md-4">
                        <label for="customerAddress" class="form-label">Địa chỉ <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="customerAddress" name="customerAddress" th:field="*{customerDTO.address}" required>
                        <p class="error text-danger" th:if="${#fields.hasErrors('customerDTO.address')}" th:errors="*{customerDTO.address}"></p>
                    </div>
                    <div class="col-md-4">
                        <label for="customerBirthdate" class="form-label">Ngày sinh</label>
                        <input type="date" class="form-control" id="customerBirthdate" name="customerBirthdate" th:field="*{customerDTO.birthDate}">
                        <p class="error text-danger" th:if="${#fields.hasErrors('customerDTO.birthDate')}" th:errors="*{customerDTO.birthDate}"></p>
                    </div>
                </div>
            </div>

            <!-- Phần sản phẩm -->
            <div class="form-container position-relative mb-3">
                <div class="red-bar"></div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold mb-0">Sản Phẩm</h5>
                    <button type="button" class="btn btn-primary" onclick="selectProduct(this)">
                        <i class="fas fa-plus me-1"></i> Thêm sản phẩm
                    </button>
                </div>

                <!-- Bảng sản phẩm -->
                <div class="table-responsive">
                    <table class="table table-bordered product-table">
                        <thead>
                        <tr>
                            <th width="50">STT</th>
                            <th>Tên Sản Phẩm</th>
                            <th width="110">Số Lượng</th>
                            <th width="150">Đơn Giá (VNĐ)</th>
                            <th width="160">Thành Tiền (VNĐ)</th>
                            <th width="50">Xóa</th>
                        </tr>
                        </thead>
                        <tbody id="productList">
                        <!-- Nội dung sản phẩm sẽ được thêm vào đây -->
                        </tbody>
                    </table>
                    <div id="noProductsMessage" class="text-center text-muted mt-3">
                        Chưa có sản phẩm nào được thêm.
                    </div>
                </div>
            </div>

            <!-- Phần thanh toán -->
            <div class="totals-container position-relative mb-3">
                <div class="red-bar"></div>
                <h5 class="fw-bold mb-3">Thanh Toán</h5>
                <div class="row mb-2">
                    <div class="col-md-6">
                        <label class="form-label">Tổng số lượng sản phẩm:</label>
                        <strong id="totalQuantity" class="ms-2">0</strong>
                    </div>
                    <div class="col-md-6 text-end">
                        <label class="form-label">Tổng tiền hàng:</label>
                        <strong id="totalAmount" class="ms-2">0</strong>
                    </div>
                </div>
                <hr class="my-2">
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <label for="discountAmount" class="form-label">Giảm giá (VNĐ):</label>
                        <input type="text" class="form-control text-end" id="discountAmount" name="discountAmount" value="0"
                               oninput="formatInputCurrency(this)" onblur="formatInputCurrency(this); calculateTotal();">
                        <span class="text-danger validation-message d-none">Giá trị không hợp lệ</span>
                    </div>
                    <div class="col-md-4">
                        <label for="discountPercent" class="form-label">Giảm giá (%):</label>
                        <input type="number" class="form-control text-end" id="discountPercent" name="discountPercent" min="0" max="100" value="0" step="0.1"
                               onchange="calculateTotal();">
                        <span class="text-danger validation-message d-none">Giá trị không hợp lệ</span>
                    </div>
                    <div class="col-md-4">
                        <label for="paymentMethod" class="form-label">Hình thức thanh toán <span class="text-danger">*</span></label>
                        <select class="form-select" id="paymentMethod" th:field="*{paymentMethod}" required>
                            <option value="0">-- Chọn phương thức --</option>
                            <option value="1">Chuyển khoản</option>
                            <option value="2">Tiền mặt</option>
                        </select>
                        <p class="error text-danger" th:if="${#fields.hasErrors('paymentMethod')}" th:errors="*{paymentMethod}"></p>
                    </div>
                </div>
                <hr class="my-2">
                <div class="row mb-2">
                    <div class="col-md-12 text-end">
                        <label class="form-label fw-bold fs-5">TỔNG GIÁ TRỊ ĐƠN HÀNG (VNĐ):</label>
                        <span id="grandTotal" class="ms-2 fw-bold fs-5 text-danger">0</span>
                        <input type="hidden" id="total" name="total" th:field="*{totalPrice}">
                    </div>
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="defaultCheck1" th:field="*{isPrintInvoice}">
                    <label class="form-check-label" for="defaultCheck1">
                        In hóa đơn
                    </label>
                </div>
            </div>

            <!-- Nút thao tác -->
            <div class="d-flex justify-content-end gap-2">
                <button type="submit" class="btn btn-success btn-action">
                    Thanh toán
                </button>
                <button type="button" class="btn btn-danger btn-action" id="cancelBtn">
                    Hủy
                </button>
            </div>
        </form>
    </div>
</main>

<!-- Modal xác nhận huỷ đơn hàng -->
<div class="modal fade" id="cancelConfirmModal" tabindex="-1" aria-labelledby="cancelConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title" id="cancelConfirmModalLabel">Xác nhận Hủy Đơn Hàng</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-flex align-items-center">
                <div class="me-3 text-dark">
                    <i class="material-icons" style="font-size:48px; color:black;">error_outline</i>
                </div>
                <div>
                    <p class="mb-0">Mọi thay đổi trong đơn hàng này sẽ bị mất và không thể khôi phục. Bạn có chắc chắn muốn hủy?</p>
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-primary" id="confirmCancelBtn">Xác nhận</button>
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Hủy</button>
            </div>
        </div>
    </div>
</div>

<div th:replace="~{admin/fragments/footer :: footer}"></div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/admin/layout.js}"></script>
<script th:src="@{/js/admin/sidebarActiveMenu.js}" defer></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Xóa dữ liệu cũ trong sessionStorage khi tải trang
        sessionStorage.removeItem("selectedProduct");
        // Lưu ý: chỉ xóa localStorage nếu đang tải trang lần đầu, không phải khi quay lại từ trang chọn sản phẩm
        if (!document.referrer.includes('/Admin/order/showListProduct')) {
            localStorage.removeItem("selectedProduct");
        }

        console.log("DOM loaded. Checking for product data...");

        // Khởi tạo mã đơn hàng
        document.getElementById("orderCode").value = "Tự sinh khi lưu";

        fetch('/Admin/order/next-code')
            .then(response => response.text())
            .then(nextCode => {
                document.getElementById("orderCode").value = nextCode;
            })
            .catch(error => {
                console.error('Error fetching next order code:', error);
                document.getElementById("orderCode").value = "Tự sinh khi lưu";
            });

        // Clear storage on page reload
        if (performance.getEntriesByType("navigation")[0]?.type === "reload") {
            sessionStorage.clear();
            localStorage.clear();
            console.log("Reloaded - storage cleared");
        }

        // Hàm cập nhật hiển thị phần sản phẩm
        function updateProductSectionDisplay() {
            const productRows = $('#productList tr.product-row').length;
            console.log(`Updating product section display. Products count: ${productRows}`);
            if (productRows > 0) {
                $('#productSection').show();
                $('#noProductsSection').hide();
            } else {
                $('#productSection').hide();
                $('#noProductsSection').show();
            }
        }

        // Kiểm tra hiển thị ban đầu
        updateProductSectionDisplay();

        // Check for selected customer data
        let selectedCustomer;
        if(localStorage.getItem("selectedCustomer") == null && sessionStorage.getItem("selectedNewCustomer") == null){
            selectedCustomer = sessionStorage.getItem("selectedCustomer");
        } else if(sessionStorage.getItem("selectedNewCustomer") != null && localStorage.getItem("selectedCustomer") == null){
            selectedCustomer = sessionStorage.getItem("selectedNewCustomer");
            // Clear session
            sessionStorage.removeItem("selectedNewCustomer");
        } else {
            selectedCustomer = localStorage.getItem("selectedCustomer");
        }

        if (selectedCustomer) {
            let customer = JSON.parse(selectedCustomer);
            // Display data on form
            document.getElementById("customerId").value = customer.id;
            document.getElementById("customerName").value = customer.name;
            document.getElementById("customerPhoneNumber").value = customer.phone;
            document.getElementById("customerAddress").value = customer.address;
            document.getElementById("customerEmail").value = customer.email;
            document.getElementById("customerBirthdate").value = customer.birthdate;

            // Delete data from localStorage after use
            localStorage.removeItem("selectedCustomer");
            // Add to session
            sessionStorage.setItem("selectedCustomer", JSON.stringify(customer));

            // Set readonly if customer ID exists
            if (customer.id) {
                document.getElementById("customerName").readOnly = true;
                document.getElementById("customerPhoneNumber").readOnly = true;
                document.getElementById("customerAddress").readOnly = true;
                document.getElementById("customerEmail").readOnly = true;
                document.getElementById("customerBirthdate").readOnly = true;
            }
        }

        // Check for selected product data
        console.log("Checking for product data in storage...");
        console.log("localStorage.selectedProduct:", localStorage.getItem("selectedProduct"));
        console.log("sessionStorage.selectedProduct:", sessionStorage.getItem("selectedProduct"));

        let selectedProduct;
        if(localStorage.getItem("selectedProduct") == null){
            selectedProduct = sessionStorage.getItem("selectedProduct");
            console.log("Using product data from sessionStorage");
        } else {
            selectedProduct = localStorage.getItem("selectedProduct");
            console.log("Using product data from localStorage");
        }

        if (selectedProduct) {
            console.log("Found selected products:", selectedProduct);
            try {
                let products = JSON.parse(selectedProduct);
                console.log("Products parsed:", products);

                // Clear existing products
                $('#productList').empty();

                if (products && Array.isArray(products) && products.length > 0) {
                    console.log("First product details:", JSON.stringify(products[0], null, 2));

                    // Add each product to the list
                    products.forEach(function(product, index) {
                        console.log(`Processing product at index ${index}:`, product);

                        // Kiểm tra tính đầy đủ của dữ liệu sản phẩm
                        if (!product.productId) {
                            console.error(`Product at index ${index} missing productId:`, product);
                            // Vẫn tiếp tục xử lý nếu có thể
                        }

                        // Check and map product price field - adjust based on your API response
                        if (product.price === undefined && product.productPrice !== undefined) {
                            product.price = product.productPrice;
                            console.log(`Mapped productPrice to price: ${product.price}`);
                        }

                        // Ensure product.quantity is a number and at least 1
                        product.quantity = Math.max(1, parseInt(product.quantity) || 1);
                        console.log(`Set quantity to ${product.quantity}`);

                        // Add product to table
                        addProductRow(product, index);
                    });

                    // Calculate totals
                    calculateTotal();

                    // Clear localStorage
                    localStorage.removeItem("selectedProduct");

                    // Add to session
                    sessionStorage.setItem("selectedProduct", JSON.stringify(products));

                    // Cập nhật hiển thị phần sản phẩm
                    updateProductSectionDisplay();
                } else {
                    console.error("Products object is not valid:", products);
                    if (!Array.isArray(products)) {
                        console.error("Products is not an array");
                    } else if (products.length === 0) {
                        console.error("Products array is empty");
                    }
                }
            } catch (e) {
                console.error("Error parsing selected products:", e);
                console.error("Raw selected products data:", selectedProduct);
            }
        } else {
            console.log("No product data found in storage");
        }

        // Event listeners
        $('#selectCustomerBtn').on('click', function() {
            window.location.href = "/Admin/order/showListCustomer";
        });

        $('#cancelBtn').on('click', function() {
            const cancelModal = new bootstrap.Modal(document.getElementById('cancelConfirmModal'));
            cancelModal.show();
        });

        $('#confirmCancelBtn').on('click', function() {
            sessionStorage.removeItem("selectedProduct");
            sessionStorage.removeItem("selectedCustomer");
            sessionStorage.removeItem("selectedNewCustomer");
            window.location.href = "/Admin/order";
        });

        // Form submission handling
        $("#orderForm").submit(function(event) {
            event.preventDefault();

            // Check if products exist
            if ($('#productList tr.product-row').length === 0) {
                alert("Vui lòng thêm ít nhất một sản phẩm vào đơn hàng");
                return;
            }

            let formData = $(this).serialize();
            console.log("Submitting form data:", formData);

            $.post({
                url: "/Admin/order/create",
                data: formData,
                success: function(response) {
                    try {
                        if (typeof response === 'string') {
                            response = JSON.parse(response);
                        }

                        console.log("Server response:", response);

                        if (response.isPrintInvoice) {
                            window.open("/Admin/order/downloadInvoicePdf?orderId=" + response.orderId, "_blank");
                        }

                        // Sửa đoạn code ở dòng 1157-1163 trong file paste-4.txt
                        if(response.paymentMethod == 1){
                            // Redirect to QR code payment page with orderId
                            window.location.href = "/Admin/payment/qr-code?orderId=" + response.orderId;
                        } else {
                            // For cash payment, redirect to order list with success parameter
                            window.location.href = "/Admin/order?successMessage=Thêm đơn hàng mới thành công!";
                        }

                        // Clear storage
                        sessionStorage.removeItem("selectedProduct");
                        sessionStorage.removeItem("selectedCustomer");
                        sessionStorage.removeItem("selectedNewCustomer");
                    } catch (e) {
                        console.error("Error processing response:", e, "Raw response:", response);
                        alert("Đã xảy ra lỗi khi xử lý phản hồi từ máy chủ");
                    }
                },
                error: function(xhr) {
                    console.error("Form submission error:", xhr);
                    if (xhr.status === 400) {
                        let errors = xhr.responseJSON;
                        console.log("Validation errors:", errors);
                        $(".error-message").remove(); // Remove old errors

                        for (let field in errors) {
                            let errorMessage = "<span class='error-message text-danger'>" + errors[field] + "</span>";
                            $('input[name="' + field + '"], select[name="' + field + '"], textarea[name="' + field + '"]').after(errorMessage);
                        }
                    } else {
                        alert("Lỗi khi gửi yêu cầu: " + xhr.statusText);
                    }
                }
            });
        });

        // Calculate initial total
        calculateTotal();
    });

    // Function to add product row to the table
    function addProductRow(product, index) {
        console.log(`Adding product row ${index}:`, product);
        const row = $('<tr class="product-row"></tr>');

        // Try to determine price from different possible fields
        let price = 0;
        if (product.price !== undefined) {
            price = parseFloat(product.price);
            console.log(`Using price field: ${price}`);
        } else if (product.productPrice !== undefined) {
            price = parseFloat(product.productPrice);
            console.log(`Using productPrice field: ${price}`);
        } else if (product.priceIndex !== undefined) {
            price = parseFloat(product.priceIndex);
            console.log(`Using priceIndex field: ${price}`);
        }

        // Ensure quantity is at least 1
        const quantity = Math.max(1, parseInt(product.quantity) || 1);

        // Giá trị nguyên (số nguyên không có dấu phân cách)
        const rawPrice = Math.round(price);
        const rowTotal = rawPrice * quantity;

        console.log(`Product ${index} data - Raw Price: ${rawPrice}, Quantity: ${quantity}, Total: ${rowTotal}`);

        // Format the price for display only
        const formattedPrice = formatCurrency(rawPrice);

        // Safe product name
        const productName = product.productName || 'Sản phẩm không có tên';

        row.html(`
<td class="stt-column">${index + 1}</td>
<td>
    <input type="hidden" name="productOrderDTOList[${index}].productId" value="${product.productId}" class="productId">
    <input type="text" class="form-control bg-light form-control-sm" name="productOrderDTOList[${index}].productName" value="${productName}" readonly>
</td>
<td>
    <input type="number" name="productOrderDTOList[${index}].quantity" class="form-control quantity-input form-control-sm text-center"
           value="${quantity}" required min="1" step="1" onchange="validateQuantity(this); calculateTotal()">
</td>
<td>
    <!-- Gửi giá trị số nguyên cho máy chủ -->
    <input type="hidden" name="productOrderDTOList[${index}].priceIndex" value="${rawPrice}" class="raw-price-input">
    <!-- Hiển thị giá trị đã định dạng cho người dùng -->
    <input type="text" class="form-control price-display form-control-sm text-end" value="${formattedPrice}" readonly>
</td>
<td>
    <input type="text" class="form-control bg-light row-total form-control-sm text-end"
           value="${formatCurrency(rowTotal)}" readonly>
</td>
<td class="text-center action-column">
    <button type="button" class="delete-btn" onclick="removeProduct(this)" title="Xóa sản phẩm này">
        <i class="fas fa-times"></i>
    </button>
</td>
`);

        $('#productList').append(row);
        console.log(`Row added for product ${productName}`);

        // Cập nhật hiển thị phần sản phẩm sau khi thêm
        updateProductSectionDisplay();
        $('#noProductsMessage').hide();
    }

    // Hàm cập nhật hiển thị phần sản phẩm
    function updateProductSectionDisplay() {
        const productRows = $('#productList tr.product-row').length;
        console.log(`updateProductSectionDisplay called: ${productRows} products`);
        if (productRows > 0) {
            $('#productSection').show();
            $('#noProductsSection').hide();
        } else {
            $('#productSection').hide();
            $('#noProductsSection').show();
        }
    }

    // Ensure quantity doesn't go below 1
    function validateQuantity(input) {
        let value = parseInt($(input).val());
        if (isNaN(value) || value < 1) {
            $(input).val(1);
        }
        calculateTotal();
    }

    // Format currency with commas
    function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN').format(amount);
    }

    // Format input currency
    function formatInputCurrency(input) {
        const value = $(input).val();
        const cleanValue = value.replace(/[^\d]/g, '');
        const formattedValue = formatCurrency(cleanValue);
        $(input).val(formattedValue);
    }

    // Calculate total price
    function calculateTotal() {
        let totalAmount = 0;
        let totalQuantity = 0;

        // Calculate row totals and update display
        $('.product-row').each(function() {
            const quantity = parseInt($(this).find('.quantity-input').val()) || 0;
            // Sử dụng giá trị số nguyên từ trường ẩn
            const price = parseInt($(this).find('.raw-price-input').val()) || 0;
            const rowTotal = quantity * price;

            $(this).find('.row-total').val(formatCurrency(rowTotal));

            totalQuantity += quantity;
            totalAmount += rowTotal;
        });

        console.log(`Calculate total - Total quantity: ${totalQuantity}, Total amount: ${totalAmount}`);

        // Update displayed totals
        $('#totalQuantity').text(totalQuantity);
        $('#totalAmount').text(formatCurrency(totalAmount));

        // Apply discounts
        const discountAmountStr = $('#discountAmount').val().replace(/[^\d]/g, '') || '0';
        const discountAmount = parseInt(discountAmountStr) || 0;
        const discountPercent = parseFloat($('#discountPercent').val()) || 0;

        let totalDiscount = discountAmount;
        if (discountPercent > 0) {
            totalDiscount += Math.round(totalAmount * discountPercent / 100);
        }

        console.log(`Discounts - Amount: ${discountAmount}, Percent: ${discountPercent}%, Total discount: ${totalDiscount}`);

        // Calculate final total
        const grandTotal = Math.max(0, totalAmount - totalDiscount);

        // Update grand total display and hidden input
        $('#grandTotal').text(formatCurrency(grandTotal));
        $('#total').val(grandTotal);

        console.log(`Grand total: ${grandTotal}`);
    }

    // Select product function
    function selectProduct(button) {
        console.log("Select product button clicked");

        // Save customer data
        let customerId = $('#customerId').val();
        if (customerId == "") {
            let customerName = $('#customerName').val();
            let customerPhoneNumber = $('#customerPhoneNumber').val();
            let customerAddress = $('#customerAddress').val();
            let customerEmail = $('#customerEmail').val();
            let customerBirthdate = $('#customerBirthdate').val();

            if (!customerName || !customerPhoneNumber || !customerEmail || !customerAddress) {
                alert("Vui lòng điền đầy đủ thông tin khách hàng trước khi thêm sản phẩm");
                return;
            }

            let customerData = {
                id: customerId,
                name: customerName,
                phone: customerPhoneNumber,
                address: customerAddress,
                email: customerEmail,
                birthdate: customerBirthdate
            };
            sessionStorage.setItem("selectedNewCustomer", JSON.stringify(customerData));
            console.log("Saved new customer data to sessionStorage", customerData);
        }

        // Create string of product IDs and quantities
        let productIdAndQuantity = [];
        $('.product-row').each(function() {
            const productId = $(this).find('.productId').val();
            const quantity = $(this).find('.quantity-input').val() || 1;

            if (productId) {
                productIdAndQuantity.push(productId + '.' + quantity);
            }
        });

        let productIdAndQuantityToString = productIdAndQuantity.join('-');
        console.log("Product IDs and quantities:", productIdAndQuantityToString);

        // Redirect to product selection page
        window.location.href = "/Admin/order/showListProduct" + (productIdAndQuantityToString ? "?oldData=" + productIdAndQuantityToString : "");
    }

    // Remove product from list
    function removeProduct(button) {
        const row = $(button).closest('tr');
        const productId = row.find('.productId').val();
        console.log(`Removing product with ID ${productId}`);

        // Remove from UI
        row.remove();

        // Reindex rows
        $('#productList tr.product-row').each(function(index) {
            $(this).find('td:first-child').text(index + 1);

            $(this).find('input, select').each(function() {
                const name = $(this).attr('name');
                if (name) {
                    const newName = name.replace(/\[\d+\]/, '[' + index + ']');
                    $(this).attr('name', newName);
                }
            });
        });

        // Remove from sessionStorage
        try {
            const selectedProducts = JSON.parse(sessionStorage.getItem("selectedProduct") || "[]");
            const updatedProducts = selectedProducts.filter(product => product.productId != productId);
            console.log(`Filtered products array - Before: ${selectedProducts.length}, After: ${updatedProducts.length}`);
            sessionStorage.setItem("selectedProduct", JSON.stringify(updatedProducts));
        } catch (e) {
            console.error("Error updating sessionStorage after product removal:", e);
        }
        if ($('#productList tr.product-row').length === 0) {
            $('#noProductsMessage').show();
        } else {
            $('#noProductsMessage').hide();
        }
        // Update calculations
        calculateTotal();

        // Cập nhật hiển thị phần sản phẩm
        updateProductSectionDisplay();
    }
</script>
</body>
</html>